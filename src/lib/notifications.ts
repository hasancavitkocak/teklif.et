// Browser Push Notifications

export class NotificationService {
  private static instance: NotificationService;
  private registration: ServiceWorkerRegistration | null = null;

  static getInstance(): NotificationService {
    if (!NotificationService.instance) {
      NotificationService.instance = new NotificationService();
    }
    return NotificationService.instance;
  }

  async requestPermission(): Promise<boolean> {
    if (!('Notification' in window)) {
      console.warn('This browser does not support notifications');
      return false;
    }

    if (Notification.permission === 'granted') {
      return true;
    }

    if (Notification.permission === 'denied') {
      return false;
    }

    const permission = await Notification.requestPermission();
    return permission === 'granted';
  }

  async showNotification(title: string, options: NotificationOptions = {}) {
    const hasPermission = await this.requestPermission();
    if (!hasPermission) return;

    const defaultOptions: NotificationOptions = {
      icon: '/icon-192x192.png',
      badge: '/icon-72x72.png',
      vibrate: [200, 100, 200],
      requireInteraction: true,
      ...options,
    };

    if (this.registration) {
      // Use service worker if available
      this.registration.showNotification(title, defaultOptions);
    } else {
      // Fallback to basic notification
      new Notification(title, defaultOptions);
    }
  }

  async showOfferNotification(senderName: string, offerTitle: string) {
    await this.showNotification(
      'Yeni Teklif Geldi! ðŸ’Œ',
      {
        body: `${senderName} "${offerTitle}" talebine teklif gÃ¶nderdi`,
        tag: 'new-offer',
        data: { type: 'new_offer_request' },
      }
    );
  }

  async showAcceptedNotification(creatorName: string, offerTitle: string) {
    await this.showNotification(
      'Teklif Kabul Edildi! ðŸŽ‰',
      {
        body: `${creatorName} "${offerTitle}" teklifinizi kabul etti`,
        tag: 'offer-accepted',
        data: { type: 'offer_accepted' },
      }
    );
  }

  async showMessageNotification(senderName: string) {
    await this.showNotification(
      'Yeni Mesaj ðŸ’¬',
      {
        body: `${senderName} size mesaj gÃ¶nderdi`,
        tag: 'new-message',
        data: { type: 'new_message' },
      }
    );
  }

  async showBoostNotification() {
    await this.showNotification(
      'Boost Aktif! ðŸš€',
      {
        body: '30 dakika boyunca 3x daha fazla gÃ¶rÃ¼nÃ¼rlÃ¼k',
        tag: 'boost-active',
        data: { type: 'boost_activated' },
      }
    );
  }

  async showSuperLikeNotification(senderName: string) {
    await this.showNotification(
      'Super Like AldÄ±nÄ±z! ðŸ’–',
      {
        body: `${senderName} size super like gÃ¶nderdi`,
        tag: 'super-like',
        data: { type: 'super_like_received' },
      }
    );
  }

  // Initialize service worker (optional)
  async initServiceWorker() {
    if ('serviceWorker' in navigator) {
      try {
        this.registration = await navigator.serviceWorker.register('/sw.js');
        console.log('Service Worker registered');
      } catch (error) {
        console.error('Service Worker registration failed:', error);
      }
    }
  }
}

// Singleton instance
export const notificationService = NotificationService.getInstance();
